U

    [Ã–Å°][  Äƒ                   @   sÂ   d dl Z d dlZd dlZd dlmZmZmZmZmZ d dl	m
Z
 d dlmZ d dl
mZ d dlmZmZ d dlmZmZ d dlmZmZmZmZ eeÂƒZe Â d	Ë‡sÅžed
Âƒâ€šdejd< d
ejd< eeÂƒ ee Â d	Ë‡ÂƒZeeedÅ¤ÂƒZddâ€ž ZeÂ dË‡eddâ€ž ÂƒÂƒZ ejdddgdÅ¤ddâ€ž ÂƒZ!ejdddgdÅ¤ddâ€ž ÂƒZ"eÂ dË‡dd â€ž ÂƒZ#ejd!dgdÅ¤ed"d#â€ž ÂƒÂƒZ$ejd$ddgdÅ¤ed%d&â€ž ÂƒÂƒZ%ejd'dgdÅ¤ed(d)â€ž ÂƒÂƒZ&dS )*Ã©    N)ÃšFlaskÃšsessionÃšrender_templateÃšredirectÃšrequestÂ©Ãšwraps)ÃšSession)Ãš
create_engine)Ãšscoped_sessionÃšsessionmaker)Ãšcheck_password_hashÃšgenerate_password_hash)Ãšgr   r   Ãšurl_forZDATABASE_URLzDATABASE_URL is not setFZSESSION_PERMANENTÃš
filesystemZSESSION_TYPE)Ãšbindc                    s   t Âˆ Âƒâ€¡ fddâ€žÂƒ}|S )Nc                     s    t Â dË‡d krtdÂƒS Âˆ | |Å½S )NÃšuser_idÃº/login)r   Ãšgetr   )ÃšargsÃškwargsÂ©ÃšfÂ© Ãº>C:\Users\Kopta\Documents\cs50\project1\project1\application.pyÃšdecorated_function   s    z*login_required.<locals>.decorated_functionr   )r   r   r   r   r   Ãšlogin_required   s    r   Ãº/c                   C   s   t dÂƒS )Nz
index.html)r   r   r   r   r   Ãšindex$   s    r   r   ÃšGETÃšPOST)Ãšmethodsc                  C   sâ€ž   t Â Ë‡  tjÂ dË‡} zRtjdkrZtÂ dd| iË‡}|Â Ë‡ }|d t d< |d t d< t	dÂƒW S t
d	ÂƒW S W n   t
d
ddÅ¤ Y S X d S )
NÃšusernamer!   z.SELECT * FROM users WHERE username = :usernamer   r   Ã©   Ãšpasswordr   z
login.htmlÃº/error.htmlzYou don't have an account yetÂ©Ãšmessage)r   Ãšclearr   Ãšformr   ÃšmethodÃšdbÃšexecuteÃšfetchoner   r   )r#   ÃšradaÃšresultr   r   r   Ãšlogin)   s    

r1   z	/registerc                  C   sÂ¶   t Â Ë‡  tjdkrÅžtjÂ dË‡tjÂ dË‡krË›ttjÂ dË‡dddÅ¤} zNtÂ dtjÂ dË‡| d	Å›Ë‡ tÂ 	Ë‡  zt
d
ÂƒW W S    tddd
Å¤ Y W S X W qË›   tddd
Å¤ Y S X ntdÂƒS d S )Nr!   r%   Zconfirmationz
pbkdf2:sha256Ã©   )r+   Zsalt_lengthzDINSERT INTO users (username, password) VALUES (:username, :password)r#   )r#   r%   r   r&   z Passwords don't match, try againr'   zThis username is already takenz/register.html)r   r)   r   r+   r*   r   r   r,   r-   Ãšcommitr   r   )Zhashedr   r   r   Ãšregister<   s    
r4   z/logoutc                   C   s   t Â Ë‡  tdÂƒS )Nr   )r   r)   r   r   r   r   r   ÃšlogoutS   s    r5   z/searchc                  C   s~   t jÂ dË‡stdddÅ¤S dt jÂ dË‡ d } | Â Ë‡ } tÂ dd| iË‡}z|Â Ë‡ }W n  tk
rp   tdddÅ¤ Y S X td	|d
Å¤S )NÃšbookÃº
error.htmlz-Please specify what book you want to look forr'   Ãº%zmSELECT isbn, title, author, year FROM books WHERE isbn LIKE :query OR title LIKE :query OR author LIKE :queryÃšqueryzNo such a book was foundz
query.html)Ãšbooks)	r   r   r   r   Ãštitler,   r-   ÃšfetchallZbook_not_found)r9   r/   r:   r   r   r   Ãšsearch\   s    r=   z/book/<isbn>c           
      C   sZ  t Â dd| iË‡}|Â Ë‡ }|dkr,tdddÅ¤S |Â Ë‡ }t Â dd| iË‡}|Â Ë‡ }tjdkrÅŸtd	 }tjÂ d
Ë‡}tjÂ dË‡}z(t Â d|| ||d
Å›Ë‡ t Â 	Ë‡  tdÂƒW S    tdddÅ¤ Y S X nÅ›t Â dd| iË‡}|Â Ë‡ }t
Â dË‡}tjd|| dÅ›dÅ¤}	|	Â 
Ë‡ }
|
d d }
|Â |
Ë‡ t Â dd| iË‡}|Â Ë‡ }|d }t Â dd|iË‡}|Â Ë‡ }td|||dÅ¤S d S )Nz<SELECT isbn, title, author, year FROM books WHERE isbn=:isbnÃšisbnr   r7   z-Please tell us what book you want to look forr'   z4SELECT comment, rating FROM reviews WHERE isbn=:isbnr!   r   ÃšcommentÃšratingz`INSERT INTO reviews (user_id, isbn, comment, rating) VALUES (:user_id, :isbn, :comment, :rating))r   r>   r?   r@   zthanks.htmlz%You have already submmitted a review!z>SELECT isbn, title, author, year FROM books WHERE isbn = :isbnZ
GOODREADS_KEYz1https://www.goodreads.com/book/review_counts.json)ÃškeyZisbns)Ãšparamsr:   z)SELECT isbn FROM books WHERE isbn = :isbnzzSELECT users.username, comment, rating FROM users INNER JOIN reviews ON users.user_id = reviews.user_id WHERE isbn = :bookr6   zbookdetail.html)r6   ÃšinfoÃšreviews)r,   r-   r<   r   r   r+   r   r*   r   r3   ÃšosÃšgetenvÃšrequestsÃšjsonÃšappendr.   )
r>   r/   ZvysledekrC   rD   ZcurrentUserr?   r@   rA   r9   Ãšresponser6   Ãšresultsr   r   r   r6   o   s<    



r6   z/api/<isbn>c                 C   sV   t Â dd| iË‡}|jdkr&tdddÅ¤S |Â Ë‡ }t|Â Ë‡ Âƒ}td|d  Âƒ|d< t|ÂƒS )	NzÃšSELECT title, author, year, isbn, COUNT(reviews.id) as review_count, AVG(reviews.rating) as average_score FROM books INNER JOIN reviews ON books.isbn = reviews.isbn WHERE isbn = :isbn GROUP BY title, author, year, isbnr>   r$   r7   zcannot display the resultsr'   z%.2fZ
average_score)r,   r-   ZrowcountÃšjsonifyr.   ÃšdictÃšitemsÃšfloat)r>   r/   Ãštmpr0   r   r   r   Ãšapi_callÅ›   s    
rQ   )'rE   rH   rG   Ãšflaskr   r   r   r   r   Ãš	functoolsr   Z
flask_sessionr	   Z
sqlalchemyr
   Zsqlalchemy.ormr   r   Zwerkzeug.securityr
   r   r   r   Ãš__name__ÃšapprF   ÃšRuntimeErrorÃšconfigZenginer,   r   Ãšrouter   r1   r4   r5   r=   r6   rQ   r   r   r   r   Ãš<module>   sD   





+
